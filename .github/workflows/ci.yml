name: Lua-Ext CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  test-windows:
    name: Test on Windows (LuaJIT)
    runs-on: windows-latest
    timeout-minutes: 10

    env:
      LUAJIT_BIN_DIR: ${{ github.workspace }}\.luajit_bin
      LUAJIT_SRC_DIR: vendor/luajit/src

    steps:
      - name: Checkout Lua-Ext
        uses: actions/checkout@v4
        with:
          # [优化 1] 停止递归！只拉取顶层 vendor 下的库
          submodules: 'true' 

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # [优化 2] 缓存 LuaJIT 编译产物
      - name: Cache LuaJIT Build
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ runner.os }}-luajit-${{ hashFiles('vendor/luajit/.git') }}
          restore-keys: |
            ${{ runner.os }}-luajit-

      # 只有在缓存未命中时才编译
      - name: Build LuaJIT
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd %LUAJIT_SRC_DIR%
          call msvcbuild.bat gc64
          if %errorlevel% neq 0 exit /b %errorlevel%
          
          mkdir "%LUAJIT_BIN_DIR%"
          copy luajit.exe "%LUAJIT_BIN_DIR%\"
          copy lua51.dll "%LUAJIT_BIN_DIR%\"
          
          mkdir "%LUAJIT_BIN_DIR%\jit"
          xcopy /s /y "jit\*.*" "%LUAJIT_BIN_DIR%\jit\"

      - name: Add LuaJIT to PATH
        shell: pwsh
        run: echo "${{ env.LUAJIT_BIN_DIR }}" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # [优化 3] 准备依赖环境
      - name: Setup Dependencies
        shell: pwsh
        run: |
          $envDir = "$PWD\.test_env"
          if (Test-Path $envDir) { Remove-Item $envDir -Recurse -Force }
          New-Item -ItemType Directory -Path $envDir -Force | Out-Null

          Write-Host "=== Setting up Environment ==="

          # 1. lua-ffi-bindings
          # 直接从当前 checkout 的 vendor 目录复制
          $ffiSource = "vendor/lua-ffi-bindings"
          $ffiDest = Join-Path $envDir "ffi"
          
          robocopy $ffiSource $ffiDest /E /XD vendor /NFL /NDL /NJH /NJS
          if ($LASTEXITCODE -ge 8) { throw "Robocopy ffi failed" }
          $LASTEXITCODE = 0

          # 2. luafilesystem (lfs_ffi.lua)
          # [FIX] 使用本地 vendor 中的文件而非下载，确保版本一致性
          # 如果 vendor/luafilesystem 存在则复制，否则回退到假设它在 sibling 目录(本地调试)
          # 在 CI 中通常作为 submodule 或独立 repo checkout
          $lfsDestDir = Join-Path $envDir "luafilesystem"
          New-Item -ItemType Directory -Path $lfsDestDir -Force | Out-Null
          
          if (Test-Path "vendor/luafilesystem/lfs_ffi.lua") {
              Copy-Item "vendor/luafilesystem/lfs_ffi.lua" $lfsDestDir
          } elseif (Test-Path "../luafilesystem/lfs_ffi.lua") {
              Copy-Item "../luafilesystem/lfs_ffi.lua" $lfsDestDir
          } else {
              # Fallback: Download if not found locally (e.g. if submodule missing)
              $lfsUrl = "https://raw.githubusercontent.com/daiaji/luafilesystem/main/lfs_ffi.lua"
              Write-Host "Downloading lfs_ffi.lua..."
              Invoke-WebRequest -Uri $lfsUrl -OutFile (Join-Path $lfsDestDir "lfs_ffi.lua")
          }

          # 3. LuaUnit
          $luUrl = "https://raw.githubusercontent.com/bluebird75/luaunit/master/luaunit.lua"
          Write-Host "Downloading luaunit.lua..."
          Invoke-WebRequest -Uri $luUrl -OutFile (Join-Path $envDir "luaunit.lua")

          # 4. Self (Lua-Ext)
          # 复制自己到测试环境
          $selfDest = Join-Path $envDir "ext"
          robocopy . $selfDest /E /XD vendor .git .test_env .luajit_bin /NFL /NDL /NJH /NJS
          if ($LASTEXITCODE -ge 8) { throw "Robocopy self failed" }
          $LASTEXITCODE = 0

      - name: Run Tests
        shell: pwsh
        run: |
          $root = ($PWD.Path -replace "\\", "/")
          
          # 设置路径
          $env:LUA_PATH = "$root/.test_env/?.lua;$root/.test_env/?/init.lua;$root/.test_env/luafilesystem/?.lua;;"
          
          Write-Host "Running Ext Tests..."
          luajit tests/test_all.lua -v