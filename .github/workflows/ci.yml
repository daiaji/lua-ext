name: Lua-Ext CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  test-suite:
    name: Full Test Suite (Windows)
    runs-on: windows-latest
    
    env:
      LUAJIT_BIN_DIR: ${{ github.workspace }}\.luajit
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache LuaJIT Build
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ runner.os }}-luajit-${{ hashFiles('vendor/luajit/.git/HEAD') }}
          restore-keys: |
            ${{ runner.os }}-luajit-

      - name: Setup MSVC
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build LuaJIT
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd vendor/luajit/src
          call msvcbuild.bat gc64
          if %errorlevel% neq 0 exit /b %errorlevel%
          
          mkdir "%LUAJIT_BIN_DIR%\bin"
          copy luajit.exe "%LUAJIT_BIN_DIR%\bin\"
          copy lua51.dll "%LUAJIT_BIN_DIR%\bin\"
          
          mkdir "%LUAJIT_BIN_DIR%\jit"
          xcopy /s /y "jit\*.*" "%LUAJIT_BIN_DIR%\jit\"

      - name: Assemble Test Environment
        shell: pwsh
        run: |
          # Create clean stage directory
          $stage = New-Item -ItemType Directory -Path "stage" -Force
          $bin   = New-Item -ItemType Directory -Path "$stage/bin"
          $lua   = New-Item -ItemType Directory -Path "$stage/lua"
          $tests = New-Item -ItemType Directory -Path "$stage/tests"
          
          # 1. Binaries
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\bin\*" $bin
          
          # 2. Dependencies
          
          # A. lua-ffi-bindings
          $ffiDest = New-Item -ItemType Directory -Path "$lua/ffi" -Force
          if (Test-Path "vendor/lua-ffi-bindings") {
             Copy-Item "vendor/lua-ffi-bindings/*" $ffiDest -Recurse -Exclude ".git"
          } else {
             Write-Warning "vendor/lua-ffi-bindings not found in submodule."
          }

          # B. luafilesystem
          $lfsDest = New-Item -ItemType Directory -Path "$lua/luafilesystem" -Force
          if (Test-Path "vendor/luafilesystem/lfs_ffi.lua") {
              Copy-Item "vendor/luafilesystem/lfs_ffi.lua" $lfsDest
          } else {
              Write-Host "Downloading lfs_ffi.lua..."
              Invoke-WebRequest -Uri "https://raw.githubusercontent.com/daiaji/luafilesystem/main/lfs_ffi.lua" -OutFile "$lfsDest/lfs_ffi.lua"
          }

          # C. LuaUnit
          Write-Host "Downloading luaunit.lua..."
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/bluebird75/luaunit/master/luaunit.lua" -OutFile "$lua/luaunit.lua"

          # D. LuaJIT Libs
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\jit" "$lua/jit" -Recurse

          # 3. Target Library (lua-ext)
          # Structure:
          #   stage/lua/ext.lua
          #   stage/lua/ext/*.lua (assert.lua, table.lua, etc)
          
          $extDir = New-Item -ItemType Directory -Path "$lua/ext" -Force
          
          # Copy all .lua files from root to stage/lua/ext/
          # [FIX] Use explicit file copy loop to ensure flattened structure from root
          Get-ChildItem -Path . -Filter "*.lua" -Exclude "setup.lua" | ForEach-Object {
              Copy-Item -Path $_.FullName -Destination $extDir
          }
          
          # Handle 'ext.lua' specially: It needs to be at stage/lua/ext.lua
          # Wait, per rockspec logic:
          #   rockspec installs 'ext/ext.lua' (repo root) into 'ext.lua' (lua path root)
          #   and 'ext/everything_else.lua' into 'ext/everything_else.lua'
          
          # So we need to move `stage/lua/ext/ext.lua` to `stage/lua/ext.lua`
          $srcExtLua = Join-Path $extDir "ext.lua"
          $dstExtLua = Join-Path $lua "ext.lua"
          
          if (Test-Path $srcExtLua) {
              Move-Item -Path $srcExtLua -Destination $dstExtLua -Force
          } else {
              Write-Error "CRITICAL: ext.lua not found in $extDir. List follows:"
              Get-ChildItem $extDir
              exit 1
          }

          # 4. Tests
          if (Test-Path "tests") {
              Copy-Item "tests/*" $tests -Recurse
          }

          # Save Path
          echo "TEST_STAGE=$($stage.FullName)" >> $env:GITHUB_ENV

      - name: Run Tests
        shell: pwsh
        env:
          # Path includes both the root lua dir (for ext.lua) and subdirs
          LUA_PATH: ${{ env.TEST_STAGE }}\lua\?.lua;${{ env.TEST_STAGE }}\lua\?\init.lua;;
        run: |
          Write-Host "Running tests in staged environment..."
          & "${{ env.TEST_STAGE }}\bin\luajit.exe" "${{ env.TEST_STAGE }}\tests\test_all.lua" -v